#!/usr/bin/env bash

# Quick dbt project setup script

echo "ðŸš€ dbt Quick Setup"
echo "=================="
echo

# Get project details
read -p "Enter project name: " project_name
if [[ -z "$project_name" ]]; then
    echo "âŒ Project name is required"
    exit 1
fi

read -p "Enter database adapter (snowflake/bigquery/postgres/redshift): " adapter
if [[ -z "$adapter" ]]; then
    adapter="postgres"
fi

read -p "Enter target environment name (default: dev): " target
if [[ -z "$target" ]]; then
    target="dev"
fi

echo
echo "ðŸ“ Creating dbt project: $project_name"
echo "ðŸŽ¯ Database adapter: $adapter"
echo "ðŸ·ï¸  Default target: $target"
echo

# Create the project
if command -v dbt >/dev/null 2>&1; then
    dbt init "$project_name"
    
    if [[ -d "$project_name" ]]; then
        cd "$project_name"
        
        # Create basic project structure
        mkdir -p models/staging models/marts models/utilities
        mkdir -p tests macros seeds
        
        # Create example model
        cat > models/staging/stg_example.sql << 'EOF'
{{ config(materialized='view') }}

select
    id,
    name,
    created_at,
    updated_at
from {{ source('raw_data', 'example_table') }}
EOF
        
        # Create basic schema file
        cat > models/staging/schema.yml << 'EOF'
version: 2

sources:
  - name: raw_data
    description: Raw data source
    tables:
      - name: example_table
        description: Example table
        columns:
          - name: id
            description: Primary key
            tests:
              - unique
              - not_null
          - name: name
            description: Name field
          - name: created_at
            description: Creation timestamp
          - name: updated_at
            description: Last update timestamp

models:
  - name: stg_example
    description: Staging model for example data
    columns:
      - name: id
        description: Primary key
        tests:
          - unique
          - not_null
EOF
        
        echo "âœ… dbt project created successfully!"
        echo
        echo "ðŸ“ Next steps:"
        echo "1. Update ~/.dbt/profiles.yml with your $adapter credentials"
        echo "2. Run: dbt debug"
        echo "3. Update models/staging/schema.yml with your actual sources"
        echo "4. Run: dbt run"
        echo
        echo "ðŸ”— Useful commands:"
        echo "   dbt_info          - Show project information"
        echo "   dbt_workflow      - Run complete workflow"
        echo "   dbt_docs_serve    - Generate and serve docs"
        echo
    else
        echo "âŒ Failed to create project directory"
        exit 1
    fi
else
    echo "âŒ dbt not found. Please install dbt first:"
    echo "   pip3 install dbt-core dbt-$adapter"
    exit 1
fi